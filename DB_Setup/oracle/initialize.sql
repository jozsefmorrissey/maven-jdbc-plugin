
--==========================  USERS  =====================--

DROP USER &2 CASCADE;

CREATE USER &2
IDENTIFIED BY &1
DEFAULT TABLESPACE users
TEMPORARY TABLESPACE temp;

GRANT connect to &2;
GRANT resource to &2;
GRANT CREATE SESSION TO &2;
GRANT CREATE TABLE TO &2;
GRANT CREATE VIEW TO &2;
GRANT CREATE MATERIALIZED VIEW TO &2;
GRANT DEBUG CONNECT SESSION TO &2;
GRANT DEBUG ANY PROCEDURE TO &2;
GRANT create session to &2;
ALTER APP_USER &2 QUOTA 10m ON users;

conn &2/&1

--==========================  SEQUENCES  =====================--

CREATE SEQUENCE BEAN_ID_SEQ START WITH 50000;
CREATE SEQUENCE FIELD_ID_SEQ START WITH 33350;
CREATE SEQUENCE TYPE_ID_SEQ START WITH 5550;
CREATE SEQUENCE FQ_CLASS_NAME_ID_SEQ START WITH 120;
CREATE SEQUENCE ANNOTATION_ID_SEQ START WITH 2500;
CREATE SEQUENCE MEMEBER_ID_SEQ START WITH 12500;
CREATE SEQUENCE MEMBER_FORMAT_ID_SEQ START WITH 120;
CREATE SEQUENCE MEMBER_ARGS_ID_SEQ START WITH 120;

--==========================  TABLES  =====================--

CREATE TABLE BEAN (
  ID NUMBER PRIMARY KEY,
  NAME VARCHAR2(64),
  PACKAGE VARCHAR2(128)
);

CREATE TABLE FIELD (
  ID NUMBER PRIMARY KEY,
  BEAN_ID NUMBER,
  SQL_NAME VARCHAR2(64),
  JAVA_NAME VARCHAR2(64),
  JAVA_TYPE VARCHAR2(64),
  SQL_TYPE VARCHAR2(64),
  CONSTRAINT FK_FIELD_BEAN FOREIGN KEY (BEAN_ID) REFERENCES BEAN(ID)
);

CREATE TABLE TYPE (
  ID NUMBER PRIMARY KEY,
  NAME VARCHAR2(64)
)

CREATE TABLE FQ_CLASS_NAME (
  ID NUMBER PRIMARY KEY,
  VALUE VARCHAR2(256)
)

CREATE TABLE ANNOTATION (
  ID NUMBER PRIMARY KEY,
  FQ_CLASS_NAME_ID NUMBER,
  TYPE_ID NUMBER,
  REF_ID NUMBER,
  CONSTRAINT FK_ANNOATION_TYPE FOREIGN KEY (TYPE_ID) REFERENCES TYPE(ID),
  CONSTRAINT FK_ANNOTATION_FQCN FOREIGN KEY (FQ_CLASS_NAME_ID) REFERENCES FQ_CLASS_NAME(ID)
);

CREATE TABLE MEMBER (
  ID NUMBER PRIMARY KEY,
  NAME VARCHAR2(64),
  FORMAT VARCHAR2(256),
);

CREATE TABLE MEMBER_FORMAT (
  ID NUMBER PRIMARY KEY,
  ANNOTATION_ID NUMBER,
  VALUE VARCHAR2,
  CONSTRAINT FK_MEM_FORMAT_ANNOTATION FOREIGN KEY ANNOTATION_ID REFERENCES ANNOTATION(ID)
)

CREATE TABLE MEMBER_ARGS (
    ID NUMBER PRIMARY KEY,
    ANNOTATION_ID NUMBER,
    FQ_CLASS_NAME_ID NUMBER,
    CONSTRAINT FK_MEM_ARGS_ANNOTATION FOREIGN KEY ANNOTATION_ID REFERENCES ANNOTATION(ID),
    CONSTRAINT FK_MEM_ARGS_FQCN FOREIGN KEY FQ_CLASS_NAME_ID REFERENCES FQ_CLASS_NAME(ID)
);


--==========================  PROCEDURES  =====================--

create or replace PROCEDURE ADD_FIELD(COLUMN_NAME IN VARCHAR2, COLUMN_TYPE IN VARCHAR2, DESCRIPTION IN VARCHAR2)
    IS
    BEGIN
        EXECUTE IMMEDIATE 'ALTER TABLE APP_USER ADD ' || COLUMN_NAME || ' ' || COLUMN_TYPE;
        INSERT INTO FIELD (NAME, DESCRIPTION, TYPE) VALUES (COLUMN_NAME, DESCRIPTION, COLUMN_TYPE);
    END;
/

--==========================  JUnit Test Data  =====================--

INSERT INTO BEAN (ID, NAME, PACKAGE) VALUES (1, 'BEAN1', 'com.package.random1')
INSERT INTO BEAN (ID, NAME, PACKAGE) VALUES (2, 'BEAN2', 'com.package.random2')

INSERT INTO FIELD (ID, BEAN_ID, SQL_NAME, JAVA_NAME) VALUES (1, 1, 'sqlName1', 'javaName1')
INSERT INTO FIELD (ID, BEAN_ID, SQL_NAME, JAVA_NAME) VALUES (2, 1, 'sqlName2', 'javaName2')

INSERT INTO FIELD (ID, BEAN_ID, SQL_NAME, JAVA_NAME) VALUES (3, 2, 'sqlName3', 'javaName3')
INSERT INTO FIELD (ID, BEAN_ID, SQL_NAME, JAVA_NAME) VALUES (4, 2, 'sqlName4', 'javaName4')

INSERT INTO FQ_CLASS_NAME (ID, VALUE) VALUES (1, 'com.custom.field.annotaion1')
INSERT INTO FQ_CLASS_NAME (ID, VALUE) VALUES (2, 'com.custom.field.annotaion2')
INSERT INTO FQ_CLASS_NAME (ID, VALUE) VALUES (3, 'com.custom.field.annotaion3')
INSERT INTO FQ_CLASS_NAME (ID, VALUE) VALUES (4, 'com.fq.class.name1')
INSERT INTO FQ_CLASS_NAME (ID, VALUE) VALUES (5, 'com.fq.class.name2')

INSERT INTO TYPE (ID, NAME) VALUES (1, 'class')
INSERT INTO TYPE (ID, NAME) VALUES (2, 'field')
INSERT INTO TYPE (ID, NAME) VALUES (3, 'method')

INSERT INTO ANNOTATION (ID, FQ_CLASS_NAME_ID, TYPE_ID, REF_ID) VALUES (1, 1, 1, 1)
INSERT INTO ANNOTATION (ID, FQ_CLASS_NAME_ID, TYPE_ID, REF_ID) VALUES (2, 1, 2, 1)
INSERT INTO ANNOTATION (ID, FQ_CLASS_NAME_ID, TYPE_ID, REF_ID) VALUES (3, 2, 2, 4)
INSERT INTO ANNOTATION (ID, FQ_CLASS_NAME_ID, TYPE_ID, REF_ID) VALUES (4, 3, 2, 4)

INSERT INTO MEMBER (ID, ANNOTATION_ID, NAME) VALUES (1, 1, 'memberName1')
INSERT INTO MEMBER (ID, ANNOTATION_ID, NAME) VALUES (2, 4, 'memberName2')
INSERT INTO MEMBER (ID, ANNOTATION_ID, NAME) VALUES (3, 4, 'memberName3')

INSERT INTO MEMBER_FORMAT(ID, ANNOTATION_ID, VALUE) VALUES (1, 1, "format='no vars'")
INSERT INTO MEMBER_FORMAT(ID, ANNOTATION_ID, VALUE) VALUES (1, 3, "format='$T != $T'")

INSERT INTO MEMBER_ARGS(ID, ANNOTATION_ID, FQ_CLASS_NAME_ID) VALUES (1, 3, 4)
INSERT INTO MEMBER_ARGS(ID, ANNOTATION_ID, FQ_CLASS_NAME_ID) VALUES (2, 3, 5)
